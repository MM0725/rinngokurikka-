<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>リンゴの木クリッカー - 昼夜サイクル統合版</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/p5.min.js"></script>

<style>
html,body { margin:0; padding:0; height:100%; background:#000; overflow:hidden; }
canvas { display:block; }
</style>
</head>

<body>
<script>
/* =======================
     画像・音
======================= */
let treeImg, stallImg;
let appleImgs = {};
let bgm, sellSound;

/* =======================
     ゲーム要素
======================= */
let money = 0;
let apples = [];
let tierUnlocked = {normal:true, gold:true, rainbow:true};

let stallX = 100;
let stallY = 350;

let sellAmountPerTick = 1;
let sellProfitMult = 1;

let stallInventory = {normal:0, gold:0, rainbow:0};
let profitEffects = [];

/* =======================
   ★ 昼夜サイクル関連
   10分 (600秒) で1周
======================= */
const CYCLE_TIME = 600 * 1000; // ミリ秒
let stars = [];

// 星の生成
function generateStars() {
    stars = [];
    for (let i = 0; i < 120; i++) {
        stars.push({
            x: random(width),
            y: random(height * 0.6),
            size: random(1, 3),
            twinkle: random(1000)
        });
    }
}

function preload(){
    // 背景音
    bgm = loadSound("sound/Floraria.mp3");
    sellSound = loadSound("sound/金額表示.mp3");

    // 画像
    treeImg = loadImage("img/tree.png");
    stallImg = loadImage("img/stall.png");
    appleImgs.normal = loadImage("img/apple_normal.png");
    appleImgs.gold = loadImage("img/apple_gold.png");
    appleImgs.rainbow = loadImage("img/apple_rainbow.png");
}

function setup(){
    createCanvas(windowWidth, windowHeight);
    generateStars();
}

function draw(){
    drawDayNightBackground();
    drawStars();

    drawTree();
    drawStall();
    dropApples();
    drawApples();
    drawProfitEffects();
    autoSell();
    drawUI();
}

/* =======================
      昼夜背景
======================= */
function drawDayNightBackground(){
    let t = (millis() % CYCLE_TIME) / CYCLE_TIME;

    // t: 0→1 のループ
    // 0.0   朝
    // 0.25  昼
    // 0.5   夕方
    // 0.75  夜
    // 1.0   朝

    let col;

    if (t < 0.25) { // 昼に向かう
        col = lerpColor(color("#87CEEB"), color("#FFFFFF"), t*4);
    } else if (t < 0.5) { // 夕方に向かう
        col = lerpColor(color("#FFFFFF"), color("#FFA07A"), (t-0.25)*4);
    } else if (t < 0.75) { // 夜に向かう
        col = lerpColor(color("#FFA07A"), color("#001030"), (t-0.5)*4);
    } else { // 朝に向かう
        col = lerpColor(color("#001030"), color("#87CEEB"), (t-0.75)*4);
    }

    background(col);
}

/* =======================
      夜の星
======================= */
function drawStars(){
    let t = (millis() % CYCLE_TIME) / CYCLE_TIME;

    // 夜の時間帯： t 0.55〜0.95
    if (t < 0.55 || t > 0.95) return;

    for (let s of stars) {
        let bright = map(sin((millis()+s.twinkle)*0.003), -1, 1, 150, 255);
        fill(bright);
        noStroke();
        ellipse(s.x, s.y, s.size);
    }
}

/* =======================
      ゲーム描画
======================= */
function drawTree(){
    image(treeImg, width/2 - 150, height/2 - 200, 300, 300);
}

function drawStall(){
    image(stallImg, stallX, stallY, 120, 100);
}

function mousePressed(){
    if (!bgm.isPlaying()) bgm.loop();

    apples.push({
        x: mouseX,
        y: mouseY,
        vy: 0,
        type: pickAppleType()
    });
}

function pickAppleType(){
    let r = random(100);
    if (r < 5) return "rainbow";
    if (r < 20) return "gold";
    return "normal";
}

function dropApples(){
    for (let a of apples){
        a.vy += 0.3;
        a.y += a.vy;

        if (a.y > stallY) {
            stallInventory[a.type]++;
            a.toDelete = true;
        }
    }
    apples = apples.filter(a => !a.toDelete);
}

function drawApples(){
    for (let a of apples){
        image(appleImgs[a.type], a.x - 12, a.y - 12, 24, 24);
    }
}

/* =======================
      販売処理
======================= */
function autoSell(){
    let sold = false;

    const T = [
        {key:"normal", value:1},
        {key:"gold", value:10},
        {key:"rainbow", value:50}
    ];

    for (let t of T){
        let n = min(stallInventory[t.key], sellAmountPerTick);
        if (n > 0){
            stallInventory[t.key] -= n;
            let profit = Math.floor(t.value * n * sellProfitMult);
            money += profit;
            sold = true;

            profitEffects.push({
                x: stallX + 40,
                y: stallY - 20,
                v: profit,
                life: 60
            });
        }
    }

    if (sold && sellSound) sellSound.play();
}

function drawProfitEffects(){
    for (let p of profitEffects){
        fill(255, 255, 0, p.life*4);
        textSize(20);
        text("+" + p.v, p.x, p.y);

        p.y -= 1;
        p.life--;
    }
    profitEffects = profitEffects.filter(p => p.life > 0);
}

/* =======================
          UI
======================= */
function drawUI(){
    fill(255);
    textSize(28);
    text("Money: " + money, 20, 40);
}

function windowResized(){
    resizeCanvas(windowWidth, windowHeight);
    generateStars();
}

</script>
</body>
</html>
