<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>ãƒªãƒ³ã‚´ã®æœ¨ã‚¯ãƒªãƒƒã‚«ãƒ¼</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/p5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/addons/p5.sound.min.js"></script>
<style>
html,body { margin:0; padding:0; overflow:hidden; background:#87CEEB; }
canvas { display:block; }
</style>
</head>
<body>

<script>

// =======================
//      ç”»åƒãƒ»éŸ³
// =======================
let treeImg, stallImg, bgImg;

// åŠ¹æœéŸ³
let clickSound;
let appleSound;
let sellSound;   // â†è¿½åŠ 
let bgm;

// =======================
//       ã‚²ãƒ¼ãƒ å¤‰æ•°
// =======================
let apples = 0;
let money = 0;
let applePrice = 1;

let groundY;
let treeX, treeY;

let stallX, stallY;

let fallingApples = [];

// =======================
//        preload
// =======================
function preload(){

  treeImg = loadImage('images/wood.png');
  stallImg = loadImage('images/yasai_mujin_hanbaijo.png');
  bgImg = loadImage('images/kabegami.webp');

  clickSound = loadSound('sound/æ±ºå®šãƒœã‚¿ãƒ³ã‚’æŠ¼ã™12.mp3');
  appleSound = loadSound('sound/ã‚­ãƒ£ãƒ³ã‚»ãƒ«9.mp3');
  sellSound = loadSound('sound/é‡‘é¡è¡¨ç¤º.mp3');  // â†è²©å£²æ™‚SEè¿½åŠ 
  bgm = loadSound('sound/Floraria.mp3');          // BGM
}

// =======================
//        setup
// =======================
function setup() {
  createCanvas(windowWidth, windowHeight);
  groundY = height * 0.85;

  // BGM å†ç”Ÿæº–å‚™
  userStartAudio().then(() => {
    if (bgm && !bgm.isPlaying()) {
      bgm.setLoop(true);
      bgm.setVolume(0.4);
      bgm.play();
    }
  });

  treeX = width * 0.5;
  treeY = groundY - 250;

  stallX = width * 0.82;
  stallY = groundY - 150;
}

// =======================
//        draw
// =======================
function draw() {
  background(135, 206, 235);

  if (bgImg) image(bgImg, 0, 0, width, height);

  // æœ¨
  image(treeImg, treeX - 150, treeY - 200, 300, 300);

  // è²©å£²æ‰€
  image(stallImg, stallX - 120, stallY - 150, 240, 240);

  // è½ä¸‹ãƒªãƒ³ã‚´
  for (let a of fallingApples) {
    fill(255, 0, 0);
    ellipse(a.x, a.y, 40, 40);
    a.y += a.speed;
  }
  fallingApples = fallingApples.filter(a => a.y < height + 50);

  // UI
  fill(255);
  rect(10, 10, 260, 90, 10);

  fill(0);
  textSize(22);
  text(`ğŸãƒªãƒ³ã‚´ï¼š${apples}`, 20, 45);
  text(`ğŸ’°ãŠé‡‘ï¼š${money}`, 20, 80);

  // è²©å£²ãƒœã‚¿ãƒ³
  drawButton(width - 160, 20, 140, 50, "è²©å£²ã™ã‚‹");
}

// =======================
//       è²©å£²å‡¦ç†
// =======================
function sellApples(){
  if (apples > 0) {
    money += apples * applePrice;
    apples = 0;

    // è²©å£²åŠ¹æœéŸ³ï¼ˆä»Šå›è¿½åŠ ï¼‰
    if (sellSound) {
      sellSound.setVolume(0.8);
      sellSound.play();
    }
  }
}

// =======================
//     ãƒœã‚¿ãƒ³æç”»
// =======================
function drawButton(x, y, w, h, label) {
  fill(255);
  rect(x, y, w, h, 10);
  fill(0);
  textSize(20);
  text(label, x + 20, y + 33);
}

// =======================
//     ã‚¿ãƒƒãƒ—å‡¦ç†
// =======================
function mousePressed() {

  // æœ¨ã‚’ã‚¿ãƒƒãƒ— â†’ ãƒªãƒ³ã‚´è½ä¸‹
  let d = dist(mouseX, mouseY, treeX, treeY);
  if (d < 150) {
    apples++;
    appleSound.play();

    fallingApples.push({
      x: treeX + random(-80, 80),
      y: treeY,
      speed: random(6, 10)
    });
  }

  // è²©å£²ãƒœã‚¿ãƒ³
  if (mouseX > width - 160 && mouseX < width - 20 &&
      mouseY > 20 && mouseY < 70) {

    clickSound.play();
    sellApples();
  }
}

</script>

</body>
</html>
