<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>リンゴの木クリッカー - 実績統合版</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/p5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/addons/p5.sound.min.js"></script>
<style>
body { margin:0; overflow:hidden; background:#222; }
#ui { position:absolute; top:10px; left:10px; color:white; font-size:20px; }
</style>
</head>

<body>
<div id="ui">
  <div id="money">お金: 0円</div>
  <div id="stock">在庫 赤0 / 金0 / 虹0</div>
  <div id="npcinfo">NPC: 0人</div>
</div>

<script>

// ----------------------------------------------------
// ● 全体変数
// ----------------------------------------------------
let bgImg, treeImg, stallImg;
let appleRed, appleGold, appleRainbow;

let bgm, clickSE, dropSE, sellSE;

let apples = [];
let npcs = [];
let sellInterval = 2000;
let lastSellTime = 0;

let money = 0;
let stock = { red:0, gold:0, rainbow:0 };

let clouds = [];
let profitEffects = [];
let achievementEffects = [];   // ←★追加
let totalCollected = 0;        // ←★追加

// ----------------------------------------------------
// ● preload（画像・音）
function preload(){
  bgImg = loadImage("images/kabegami.webp");
  treeImg = loadImage("images/wood.png");
  stallImg = loadImage("images/yasai_mujin_hanbaijo.png");

  appleRed = loadImage("images/akairo.png");
  appleGold = loadImage("images/kinniro.png");
  appleRainbow = loadImage("images/niiiro.png");

  soundFormats('mp3');
  bgm = loadSound("sound/Floraria.mp3");
  clickSE = loadSound("sound/click.mp3");
  dropSE = loadSound("sound/apple_drop.mp3");
  sellSE = loadSound("sound/金額表示.mp3");
}

// ----------------------------------------------------
// ● setup
function setup(){
  createCanvas(windowWidth, windowHeight);

  // BGM
  bgm.setLoop(true);
  bgm.setVolume(0.5);
  bgm.play();

  // 雲生成
  for(let i=0;i<5;i++){
    clouds.push({
      x: random(width),
      y: random(50,200),
      speed: random(0.2,0.5),
      size: random(120,200)
    });
  }
}

// ----------------------------------------------------
// ● draw
function draw(){
  background(0);

  // 背景
  image(bgImg,0,0,width,height);

  // 雲
  drawClouds();

  // 木
  image(treeImg, width/2-150, height/2-200, 300, 300);

  // 販売所
  image(stallImg, 150, height-250, 300, 250);

  // リンゴ更新
  updateApples();
  drawApples();

  // NPC
  updateNPCs();
  drawNPCs();

  // 利益エフェクト
  drawProfitEffects();

  // ★ 実績エフェクト
  drawAchievementEffects();

  // 自動販売
  autoSell();

  // UI
  document.getElementById("money").innerText = `お金: ${money}円`;
  document.getElementById("stock").innerText =
    `在庫 赤${stock.red} / 金${stock.gold} / 虹${stock.rainbow}`;
  document.getElementById("npcinfo").innerText = `NPC: ${npcs.length}人`;
}

// ----------------------------------------------------
// ● 雲
function drawClouds(){
  noStroke();
  fill(255,255,255,200);
  for(let c of clouds){
    ellipse(c.x, c.y, c.size, c.size*0.6);
    c.x += c.speed;
    if(c.x > width + 100) c.x = -100;
  }
}

// ----------------------------------------------------
// ● クリック → リンゴ生成
function mousePressed(){
  clickSE.play();
  spawnApple();
}

function spawnApple(){
  apples.push({
    x: random(width/2-100, width/2+100),
    y: height/2-220,
    vy: 0,
    state: "fall",
    tier: getTier()
  });
}

// ティア抽選
function getTier(){
  let r = random(1);
  if(r < 0.05) return "rainbow";
  if(r < 0.25) return "gold";
  return "red";
}

// ----------------------------------------------------
// ● リンゴ更新
function updateApples(){
  for(let a of apples){
    if(a.state === "fall"){
      a.vy += 0.5;
      a.y += a.vy;

      if(a.y > height - 80){
        a.y = height - 80;
        a.vy *= -0.4;
        if(abs(a.vy) < 1) a.state = "ground";
        dropSE.play();
      }
    }
  }
}

// ----------------------------------------------------
// ● リンゴ描画
function drawApples(){
  for(let a of apples){
    let img =
      a.tier === "red" ? appleRed :
      a.tier === "gold" ? appleGold : appleRainbow;
    image(img, a.x-25, a.y-25, 50, 50);
  }
}

// ----------------------------------------------------
// ● NPC（簡略版）
function updateNPCs(){
  for(let n of npcs){

    // ターゲットリンゴが無いなら探す
    if(n.state === "wait"){
      let targetIndex = apples.findIndex(a => a.state==="ground");
      if(targetIndex !== -1){
        n.target = targetIndex;
        n.state = "toApple";
      }
    }

    // リンゴへ移動
    if(n.state==="toApple"){
      let a = apples[n.target];
      if(!a){ n.state="wait"; continue; }

      n.x += (a.x - n.x)*0.05;
      n.y += (a.y - n.y)*0.05;

      if(dist(n.x,n.y,a.x,a.y) < 20){
        // ★ 拾った瞬間に収穫数カウント
        totalCollected++;

        // ★ 2の倍数なら実績エフェクト
        if(totalCollected % 2 === 0){
          achievementEffects.push({
            x: a.x,
            y: a.y - 40,
            text: `実績 ${totalCollected}個達成！`,
            life: 100
          });
        }

        // 在庫へ
        if(a.tier === "red") stock.red++;
        if(a.tier === "gold") stock.gold++;
        if(a.tier === "rainbow") stock.rainbow++;

        apples.splice(n.target,1);
        n.state = "toStall";
      }
    }

    // 販売所へ移動
    if(n.state==="toStall"){
      n.x += (250 - n.x)*0.05;
      n.y += (height-140 - n.y)*0.05;

      if(dist(n.x,n.y,250,height-140) < 20){
        n.state = "wait";
      }
    }
  }
}

// ----------------------------------------------------
// ● NPC描画
function drawNPCs(){
  fill(255,230,180);
  noStroke();
  for(let n of npcs){
    ellipse(n.x, n.y, 40, 40);
  }
}

// ----------------------------------------------------
// ● 利益エフェクト
function drawProfitEffects(){
  for(let i=profitEffects.length-1; i>=0; i--){
    let p = profitEffects[i];
    fill(255,255,0);
    textSize(22);
    text("+"+p.value, p.x, p.y);
    p.y -= 0.4;
    p.life--;
    if(p.life<=0) profitEffects.splice(i,1);
  }
}

// ----------------------------------------------------
// ● ★ 実績エフェクト描画（今回追加）
function drawAchievementEffects(){
  for(let i=achievementEffects.length-1; i>=0; i--){
    let a = achievementEffects[i];
    fill(255,200,0);
    stroke(0);
    strokeWeight(2);
    textSize(26);
    text(a.text, a.x, a.y);
    a.y -= 0.4;
    a.life--;
    if(a.life<=0) achievementEffects.splice(i,1);
  }
}

// ----------------------------------------------------
// ● 自動販売
function autoSell(){
  if(millis() - lastSellTime < sellInterval) return;

  lastSellTime = millis();

  let sold = 0;
  if(stock.red > 0){ stock.red--; money += 20; sold=20; }
  else if(stock.gold > 0){ stock.gold--; money += 60; sold=60; }
  else if(stock.rainbow > 0){ stock.rainbow--; money += 200; sold=200; }
  else return;

  sellSE.play();

  profitEffects.push({
    x: 250,
    y: height-260,
    value: sold,
    life: 60
  });
}

// ----------------------------------------------------
</script>
</body>
</html>
