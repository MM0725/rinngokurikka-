<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>リンゴの木クリッカー - 完全版</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/p5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/addons/p5.sound.min.js"></script>
<style>
html,body { margin:0; padding:0; height:100%; overflow:hidden; }
canvas { display:block; position:absolute; top:0; left:0; z-index:0; }
#ui { position:absolute; left:12px; top:10px; color:#fff; font-family:sans-serif; text-shadow:0 0 6px #0008; z-index:20; }
#counts { font-size:20px; }
#money { position:absolute; top:10px; right:10px; font-size:24px; font-weight:bold; color:#fff; text-shadow:0 0 6px #0008; z-index:20; }
#money span { margin-left:8px; }
#actions { position:absolute; top:60px; right:10px; z-index:20; text-align:right; }
#actions button { background:#333; color:#fff; border:none; padding:10px; border-radius:8px; cursor:pointer; margin-bottom:6px; display:block; width:250px; font-size:16px; }
</style>
</head>
<body>

<div id="ui"><div id="counts">赤:0　金:0　虹:0</div></div>
<div id="money">所持金: <span id="moneyVal">1000</span>円 <span id="npcCount">NPC:0</span></div>

<div id="actions">
  <button id="tierUpBtn">高ティア確率UP</button>
  <button id="hireBtn">従業員雇用</button>
  <button id="speedUpBtn">販売スピードUP</button>
  <button id="profitUpBtn">販売利益UP</button>
  <button id="npcSpeedBtn">NPC速度UP</button>
  <button id="sellAmountUpBtn">一度に販売個数UP</button>
</div>

<script>
let treeImg, stallImg, bgImg;
let apples=[], npcs=[], groundY;
let money=1000, hiredCount=0;
let stallInventory={red:0,gold:0,rainbow:0};
let sellInterval=2000, sellAmountPerTick=1, sellProfitMult=1;

let clouds=[];

const TIERS=[
  { key:'red', value:20, rgb:[230,60,60], imgPath:'images/akairo.png', img:null },
  { key:'gold', value:60, rgb:[240,220,60], imgPath:'images/kinniro.png', img:null },
  { key:'rainbow', value:200, rgb:[200,100,255], imgPath:'images/niiiro.png', img:null }
];

let tierBase={red:1.0,gold:0,rainbow:0};
let upgradeCounts={tier:0,hire:0,speed:0,profit:0,npcSpeed:0};
let basePrices={tier:100,hire:100,speed:100,profit:100,npcSpeed:100,sellAmount:100};
let growthRate=1.2, hireGrowthRate=1.1, npcSpeedGrowth=1.2;

let stallX, stallY, treeX, treeY, maxTreeW=600, displayH;

function preload(){
  treeImg = loadImage('images/wood.png');
  stallImg = loadImage('images/yasai_mujin_hanbaijo.png');
  bgImg = loadImage('images/kabegami.webp');
  for(let t of TIERS){ t.img = loadImage(t.imgPath); }
}

function setup(){
  let cnv = createCanvas(windowWidth, windowHeight);
  cnv.position(0,0); cnv.style('z-index','0');

  groundY = height*0.85;
  stallX = width*0.82; stallY = groundY - 20;
  treeX = width*0.28; treeY = groundY - 250 + 2*34;
  if(treeImg) displayH = maxTreeW * (treeImg.height/treeImg.width);

  for(let i=0;i<5;i++){
    clouds.push({x:random(width),y:random(50,200),speed:random(0.2,0.6),size:random(80,150)});
  }

  for(let i=0;i<14;i++) spawnAppleOnTree();

  setInterval(autoSell,sellInterval);

  document.getElementById('hireBtn').addEventListener('click',()=>{ hireEmployee(); });
  document.getElementById('tierUpBtn').addEventListener('click',()=>{ increaseTierChance(); });
  document.getElementById('speedUpBtn').addEventListener('click',()=>{ decreaseSellInterval(); });
  document.getElementById('profitUpBtn').addEventListener('click',()=>{ increaseSellProfit(); });
  document.getElementById('npcSpeedBtn').addEventListener('click',()=>{ increaseNPCSpeed(); });
  document.getElementById('sellAmountUpBtn').addEventListener('click',()=>{ increaseSellAmount(); });

  updateUI();
}

function windowResized(){
  resizeCanvas(windowWidth, windowHeight);
  groundY = height*0.85;
  stallX = width*0.82; stallY = groundY-20;
  treeX = width*0.28; treeY = groundY - 250 + 2*34;
}

function draw(){
  if(bgImg) image(bgImg,0,0,width,height); else background(135,206,235);
  drawClouds();
  drawGround();
  drawTree();
  drawStall();
  drawApples();
  drawNPCs();
}

function drawClouds(){
  noStroke(); fill(255,255,255,240);
  for(let c of clouds){
    ellipse(c.x,c.y,c.size,c.size*0.6);
    ellipse(c.x+c.size*0.4,c.y+10,c.size*0.8,c.size*0.5);
    ellipse(c.x-c.size*0.4,c.y+10,c.size*0.8,c.size*0.5);
    c.x+=c.speed; if(c.x>width+100){c.x=-100;c.y=random(50,200);}
  }
}

function drawGround(){ fill(90,60,40); rect(0,groundY,width,height-groundY); }
function drawTree(){ if(treeImg) imageMode(CENTER); image(treeImg,treeX,treeY,maxTreeW,displayH); }
function drawStall(){ if(stallImg) imageMode(CENTER); image(stallImg,stallX,stallY-50,100*2.5,100*2.5); }

function drawApples(){
  for(let a of apples){
    if(a.state!=='picked'){
      let t=TIERS[a.tier];
      if(t.img) image(t.img,a.x,a.y,34,34); else { fill(...t.rgb); ellipse(a.x,a.y,34,34); }
    }
  }
}

function spawnAppleOnTree(){
  let p=random(), tier;
  if(p<tierBase.red) tier=0;
  else if(p<tierBase.red+tierBase.gold) tier=1;
  else tier=2;
  let rx=random(-maxTreeW*0.2,maxTreeW*0.2);
  let ry=random(treeY - displayH*0.4, treeY - displayH*0.1);
  apples.push({x:treeX+rx,y:ry,tier:tier,state:'onTree',vy:0,vx:0,bounced:false});
}

function mousePressed(){
  for(let a of apples){
    if(a.state==='onTree' && dist(mouseX,mouseY,a.x,a.y)<22){
      a.state='falling'; a.vy=0; a.vx=random(-0.6,0.6); a.bounced=false;
      setTimeout(spawnAppleOnTree,200+random(0,300));
      break;
    }
  }
}

function updateUI(){
  document.getElementById('counts').innerText=
    `赤:${stallInventory.red}　金:${stallInventory.gold}　虹:${stallInventory.rainbow}`;
  document.getElementById('moneyVal').innerText=money.toLocaleString();
  document.getElementById('npcCount').innerText=`NPC:${hiredCount}`;
}
function hireEmployee(){ npcs.push({x:treeX,y:groundY-20,state:'idle',carryTier:null,speed:2,homeX:treeX,homeY:groundY-20,name:`NPC${hiredCount+1}`}); hiredCount++; updateUI(); }
function increaseTierChance(){ tierBase.red=0.7; tierBase.gold=0.25; tierBase.rainbow=0.05; }
function decreaseSellInterval(){ sellInterval=Math.max(500,sellInterval-200); }
function increaseSellProfit(){ sellProfitMult*=1.2; }
function increaseNPCSpeed(){ for(let n of npcs)n.speed+=0.5; }
function increaseSellAmount(){ sellAmountPerTick++; }

function drawNPCs(){
  for(let n of npcs){
    push();
    translate(n.x,n.y);
    fill(0,0,0,60); ellipse(0,22,32,10);
    fill(220,200,180); rect(-9,-18,18,26,6);
    fill(255,220,180); ellipse(0,-28,24,24);
    fill(0); ellipse(-4,-30,3,3); ellipse(4,-30,3,3);
    pop();
  }
}

function autoSell(){
  for(let t of TIERS){
    let sellNum=Math.min(stallInventory[t.key],sellAmountPerTick);
    if(sellNum>0){ stallInventory[t.key]-=sellNum; money+=t.value*sellNum*sellProfitMult; }
  }
  updateUI();
}
</script>

</body>
</html>
